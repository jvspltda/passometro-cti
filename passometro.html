<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Passômetros - CTI (Online)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" xintegrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoVBL5gI9kLmbG0C+wFjr8bCqwY2SA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2b6cb0;
            --primary-hover: #2c5282;
            --sidebar-bg: #1a202c;
            --sidebar-text: #e2e8f0;
            --sidebar-active-bg: #2d3748;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .form-section {
            background-color: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 1rem;
        }
        .form-field { display: flex; flex-direction: column; }
        .form-field label { font-size: 0.8rem; font-weight: 600; color: #4a5568; margin-bottom: 0.25rem; }
        .form-field input, .form-field textarea {
            border: 1px solid #e2e8f0; border-radius: 0.375rem; padding: 0.5rem 0.75rem;
            font-size: 0.9rem; color: #2d3748; transition: border-color 0.2s;
        }
        .form-field input:focus, .form-field textarea:focus {
            outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 1px var(--primary-color);
        }
        .form-field textarea { min-height: 100px; resize: vertical; }
        
        .admissao-field {
            display: flex;
            flex-direction: column;
            margin-bottom: 1.5rem;
        }
        .admissao-field label {
            font-size: 0.9rem; font-weight: 700; color: #1a202c; margin-bottom: 0.5rem;
            border-bottom: 2px solid #e2e8f0; padding-bottom: 0.25rem;
        }
        .admissao-field textarea {
            min-height: 220px;
        }

        .col-span-2 { grid-column: span 2 / span 2; }
        .col-span-3 { grid-column: span 3 / span 3; }
        .col-span-4 { grid-column: span 4 / span 4; }
        .col-span-5 { grid-column: span 5 / span 5; }
        .col-span-6 { grid-column: span 6 / span 6; }
        .col-span-7 { grid-column: span 7 / span 7; }
        .col-span-12 { grid-column: span 12 / span 12; }

        .tab-button {
            padding: 0.75rem 1.5rem; font-weight: 600; cursor: pointer;
            border-bottom: 3px solid transparent; transition: all 0.3s ease;
        }
        .tab-button.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        .tab-button:not(.active):hover { background-color: #edf2f7; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .daily-record { page-break-before: always; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex; align-items: center; justify-content: center;
            z-index: 50; opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
        }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal-content {
            background-color: white; padding: 2rem; border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -2px rgb(0 0 0 / 0.1);
            max-width: 500px; width: 90%;
            transform: scale(0.95); transition: transform 0.3s ease;
        }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        
        body.pdf-generating {
            background-color: white !important;
        }
        .pdf-generating .form-section {
            box-shadow: none !important;
            border: 1px solid #eee;
        }

        @media print {
            body { background-color: white; font-size: 10pt; -webkit-print-color-adjust: exact; }
            .no-print { display: none !important; }
            #main-container > aside { display: none; }
            #main-content { margin-left: 0 !important; }
            .printable-area { padding: 0; }
            .printable-area .form-section {
                box-shadow: none; border: 1px solid #ccc;
                padding: 1rem; margin-bottom: 1rem;
                page-break-inside: avoid;
            }
            .printable-area .daily-record { page-break-before: always; }
            .printable-area .daily-record:first-of-type { page-break-before: avoid; }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="main-container" class="flex h-screen">
        <!-- Sidebar para seleção de Box -->
        <aside class="w-48 bg-gray-800 text-gray-200 p-4 flex flex-col no-print">
            <h2 class="text-xl font-bold mb-6 text-white text-center">Boxes CTI</h2>
            <nav id="box-selector" class="flex flex-col space-y-2"></nav>
            <div id="connection-status" class="mt-auto text-center text-xs text-gray-400">
                Conectando...
            </div>
        </aside>

        <!-- Conteúdo Principal -->
        <div id="main-content" class="flex-1 p-6 overflow-y-auto">
            <header class="mb-6">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                    <div>
                        <h1 id="header-title" class="text-3xl font-bold text-gray-800">Selecione um Box</h1>
                        <p id="header-subtitle" class="text-gray-500 mt-1">Nenhum paciente admitido</p>
                    </div>
                </div>
            </header>
            
            <div id="management-panel" class="form-section mb-6 no-print hidden">
                <h3 class="text-lg font-bold text-gray-700 mb-4">Gerenciamento do Passômetro</h3>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <button onclick="window.showModal('new')" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition duration-300">Novo Passômetro</button>
                    <button onclick="window.showModal('restore')" class="bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-600 transition duration-300">Restaurar Backup</button>
                    <button onclick="window.showModal('end')" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition duration-300">Encerrar e Gerar PDF</button>
                </div>
            </div>

            <div id="tabs-nav" class="border-b border-gray-200 mb-6 no-print hidden">
                <nav class="flex flex-wrap">
                    <button id="tab-btn-admissao" class="tab-button active" onclick="window.switchTab('admissao')">Folha de Admissão</button>
                    <button id="tab-btn-passometro" class="tab-button" onclick="window.switchTab('passometro')">Passômetro Diário</button>
                </nav>
            </div>

            <main id="printable-area">
                <div id="tab-content-admissao" class="tab-content"></div>
                <div id="tab-content-passometro" class="tab-content">
                    <div class="flex justify-end mb-4 no-print">
                        <button onclick="window.addDailyRecord()" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                            Adicionar Novo Dia
                        </button>
                    </div>
                    <div id="daily-records-container" class="space-y-6"></div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal de Confirmação e Loading -->
    <div id="modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-title" class="text-xl font-bold mb-4"></h3>
            <p id="modal-text" class="text-gray-600 mb-6"></p>
            <div id="modal-buttons" class="flex justify-end space-x-4">
                <button id="modal-cancel" onclick="window.hideModal()" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Cancelar</button>
                <button id="modal-confirm" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Confirmar</button>
            </div>
            <div id="modal-loading" class="hidden text-center">
                <svg class="animate-spin h-8 w-8 text-blue-600 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p id="modal-loading-text" class="text-gray-700 font-semibold">Gerando PDF, por favor aguarde...</p>
            </div>
        </div>
    </div>

    <!-- Templates -->
    <template id="admissao-template">
        <div class="form-section">
            <header class="text-center mb-8">
                <h1 class="text-2xl font-bold text-gray-800">FOLHA DE ADMISSÃO</h1>
                <p class="text-gray-600">Centro de Terapia Intensiva (CTI)</p>
            </header>
            <section class="border-t border-b border-gray-200 py-4 mb-8">
                <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
                    <div class="md:col-span-6 form-field !mb-0">
                        <label class="!border-0 !p-0 !m-0 text-sm font-medium text-gray-700">NOME DO PACIENTE</label>
                        <input type="text" data-field="nome" class="ad-field mt-1 block w-full border-gray-300 rounded-md shadow-sm sm:text-sm p-2" placeholder="Nome completo do paciente">
                    </div>
                    <div class="md:col-span-2 form-field !mb-0">
                        <label class="!border-0 !p-0 !m-0 text-sm font-medium text-gray-700">IDADE</label>
                        <input type="text" data-field="idade" class="ad-field mt-1 block w-full border-gray-300 rounded-md shadow-sm sm:text-sm p-2" placeholder="Ex: 53 anos">
                    </div>
                    <div class="md:col-span-2 form-field !mb-0">
                        <label class="!border-0 !p-0 !m-0 text-sm font-medium text-gray-700">DATA ADMISSÃO</label>
                        <input type="date" data-field="dataAdmissao" class="ad-field mt-1 block w-full border-gray-300 rounded-md shadow-sm sm:text-sm p-2">
                    </div>
                     <div class="md:col-span-2 form-field !mb-0">
                        <label class="!border-0 !p-0 !m-0 text-sm font-medium text-gray-700">BOX</label>
                        <input type="text" data-field="box" class="ad-field mt-1 block w-full border-gray-300 rounded-md shadow-sm sm:text-sm p-2" placeholder="Ex: BOX-05">
                    </div>
                </div>
            </section>
            <main class="grid grid-cols-1 md:grid-cols-2 gap-x-8">
                <div>
                    <div class="admissao-field"><label>HISTÓRIA CLÍNICA ATUAL</label><textarea data-field="historia" class="ad-field"></textarea></div>
                    <div class="admissao-field"><label>TRATAMENTO REALIZADO PREVIAMENTE</label><textarea data-field="tratamentoPrevio" class="ad-field"></textarea></div>
                    <div class="admissao-field"><label>COMORBIDADES</label><textarea data-field="comorbidades" class="ad-field"></textarea></div>
                </div>
                <div>
                    <div class="admissao-field"><label>EXAMES RELEVANTES</label><textarea data-field="examesRelevantes" class="ad-field"></textarea></div>
                    <div class="admissao-field"><label>MEDICAMENTOS DE USO CONTÍNUO</label><textarea data-field="medicamentosContinuo" class="ad-field"></textarea></div>
                    <div class="admissao-field"><label>CONDUTA INICIAL</label><textarea data-field="condutaInicial" class="ad-field"></textarea></div>
                </div>
            </main>
        </div>
    </template>

    <template id="daily-record-template">
        <div class="form-section daily-record">
            <div class="flex justify-between items-center border-b pb-2 mb-6">
                 <h2 class="text-xl font-bold text-gray-700">Passômetro - Dia <span class="record-date-display"></span></h2>
                 <div class="flex items-center space-x-2 no-print">
                    <button onclick="window.removeDailyRecord(this)" class="text-red-500 hover:text-red-700 font-bold" title="Remover este dia">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    </button>
                 </div>
            </div>
            <div class="form-grid">
                <div class="form-field col-span-12 sm:col-span-5"><label>PACIENTE</label><input type="text" class="paciente-nome" readonly></div>
                <div class="form-field col-span-4 sm:col-span-2"><label>DATA</label><input type="date" class="record-date daily-field" data-field="date"></div>
                <div class="form-field col-span-8 sm:col-span-5"><label>COMORBIDADES</label><input type="text" class="comorbidades" readonly></div>
                <div class="form-field col-span-12 sm:col-span-6"><label>DIAGNÓSTICO PRIMÁRIO</label><textarea class="daily-field" data-field="diagPrimario"></textarea></div>
                <div class="form-field col-span-12 sm:col-span-6"><label>DIAGNÓSTICO SECUNDÁRIO</label><textarea class="daily-field" data-field="diagSecundario"></textarea></div>
                <div class="form-field col-span-12 sm:col-span-3"><label>INVASIVOS</label><textarea class="daily-field" data-field="invasivos"></textarea></div>
                <div class="form-field col-span-6 sm:col-span-3"><label>VM/O2 SUPLEMENTAR</label><textarea class="daily-field" data-field="vmO2"></textarea></div>
                <div class="form-field col-span-6 sm:col-span-3"><label>ATB</label><textarea class="daily-field" data-field="atb"></textarea></div>
                <div class="form-field col-span-12 sm:col-span-3"><label>ESPECIALISTA</label><textarea class="daily-field" data-field="especialista"></textarea></div>
                <div class="form-field col-span-12 sm:col-span-4"><label>GASOMETRIAS</label><textarea class="daily-field" data-field="gasometrias"></textarea></div>
                <div class="form-field col-span-12 sm:col-span-4"><label>NUTRIÇÃO</label><textarea class="daily-field" data-field="nutricao"></textarea></div>
                <div class="form-field col-span-6 sm:col-span-2"><label>CULTURAS</label><textarea class="daily-field" data-field="culturas"></textarea></div>
                <div class="form-field col-span-6 sm:col-span-2"><label>TRANSFUSÕES</label><textarea class="daily-field" data-field="transfusoes"></textarea></div>
                <div class="form-field col-span-12 sm:col-span-6"><label>DIURNO - EVOLUÇÃO</label><textarea class="daily-field" data-field="evoDiurno" style="min-height: 150px;"></textarea></div>
                <div class="form-field col-span-12 sm:col-span-6"><label>NOTURNO - EVOLUÇÃO</label><textarea class="daily-field" data-field="evoNoturno" style="min-height: 150px;"></textarea></div>
                <div class="form-field col-span-6 sm:col-span-2"><label>GLICEMIAS</label><textarea class="daily-field" data-field="glicemias" style="min-height: 120px;"></textarea></div>
                <div class="form-field col-span-6 sm:col-span-2"><label>FEBRE</label><textarea class="daily-field" data-field="febre" style="min-height: 120px;"></textarea></div>
                <div class="form-field col-span-6 sm:col-span-2"><label>DIURESE</label><textarea class="daily-field" data-field="diurese" style="min-height: 120px;"></textarea></div>
                <div class="form-field col-span-6 sm:col-span-2"><label>EVACUAÇÕES</label><textarea class="daily-field" data-field="evacuacoes" style="min-height: 120px;"></textarea></div>
                <div class="form-field col-span-6 sm:col-span-2"><label>BALANÇO HÍDRICO</label><textarea class="daily-field" data-field="balanco" style="min-height: 120px;"></textarea></div>
                <div class="form-field col-span-6 sm:col-span-2"><label>DRENOS</label><textarea class="daily-field" data-field="drenos" style="min-height: 120px;"></textarea></div>
                <div class="form-field col-span-12 sm:col-span-4"><label>MEDICAMENTOS</label><textarea class="daily-field" data-field="medicamentos" style="min-height: 200px;"></textarea></div>
                <div class="form-field col-span-12 sm:col-span-4"><label>EXAMES DO DIA / RELEVANTES</label><textarea class="daily-field" data-field="exames" style="min-height: 200px;"></textarea></div>
                <div class="form-field col-span-12 sm:col-span-4"><label>CONDUTA</label><textarea class="daily-field" data-field="conduta" style="min-height: 200px;"></textarea></div>
            </div>
        </div>
    </template>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        let app, auth, db;
        let appData = {};
        let currentBoxId = null;
        let modalAction = null;
        let unsubscribe; 
        let debounceTimer;

        // --- ESTRUTURA DE DADOS ---
        function getEmptyBoxData() {
            return {
                admissao: {
                    nome: '', idade: '', dataAdmissao: '', box: '',
                    historia: '', tratamentoPrevio: '', comorbidades: '',
                    examesRelevantes: '', medicamentosContinuo: '', condutaInicial: ''
                },
                passometros: []
            };
        }

        // --- GERENCIAMENTO DE ESTADO (FIRESTORE / LOCALSTORAGE) ---
        async function saveState(isBackup = false) {
            if (!currentBoxId || !appData[currentBoxId]) return;

            const cleanData = JSON.parse(JSON.stringify(appData[currentBoxId]));

            if (db) { // Online Mode
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-passometro-app';
                const docRef = doc(db, "artifacts", appId, "public", "data", "passometros", "allData");
                const dataToSave = isBackup ? { [`backup_${currentBoxId}`]: cleanData } : { [currentBoxId]: cleanData };
                try {
                    await setDoc(docRef, dataToSave, { merge: true });
                } catch (error) {
                    console.error("Erro ao salvar dados no Firestore: ", error);
                    document.getElementById('connection-status').textContent = 'Erro de conexão';
                }
            } else { // Offline Mode
                localStorage.setItem('passometroAppData', JSON.stringify(appData));
            }
        }

        function loadStateFromLocalStorage() {
            const savedData = localStorage.getItem('passometroAppData');
            if (savedData) {
                appData = JSON.parse(savedData);
            } else {
                for (let i = 1; i <= 9; i++) {
                    appData[`box${i}`] = null;
                }
            }
        }

        function debounceSaveState() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                saveState();
            }, 1000);
        }
        
        // --- LÓGICA DA INTERFACE (UI) ---
        function switchTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`tab-btn-${tabName}`).classList.add('active');
            const contentTab = document.getElementById(`tab-content-${tabName}`);
            if(contentTab) contentTab.classList.add('active');
        }

        function switchBox(boxId) {
            currentBoxId = boxId;
            document.querySelectorAll('#box-selector button').forEach(b => b.classList.remove('bg-gray-600'));
            document.querySelector(`#box-selector button[data-boxid="${boxId}"]`).classList.add('bg-gray-600');
            renderBoxData();
        }
        
        function updateHeader() {
            if (!currentBoxId) return;
            const boxData = appData[currentBoxId];
            const nome = boxData && boxData.admissao ? boxData.admissao.nome : '';
            document.getElementById('header-title').textContent = `BOX ${currentBoxId.replace('box', '0')}`;
            document.getElementById('header-subtitle').textContent = nome ? `Paciente: ${nome}` : 'Nenhum paciente admitido';
        }

        function renderBoxData() {
            if (!currentBoxId) return;
            
            const activeTabButton = document.querySelector('#tabs-nav .tab-button.active');
            const activeTabId = activeTabButton ? activeTabButton.id.replace('tab-btn-', '') : 'admissao';

            const boxData = appData[currentBoxId];
            
            document.getElementById('management-panel').classList.remove('hidden');

            if (boxData === null) {
                updateHeader();
                document.getElementById('tabs-nav').classList.add('hidden');
                document.getElementById('tab-content-admissao').innerHTML = '';
                document.getElementById('tab-content-passometro').classList.add('hidden');
                
                const restoreBtn = document.querySelector("button[onclick*='restore']");
                const endBtn = document.querySelector("button[onclick*='end']");
                [restoreBtn, endBtn].forEach(btn => {
                    if(btn) {
                        btn.disabled = true;
                        btn.classList.add('opacity-50', 'cursor-not-allowed');
                    }
                });
                return;
            }

            document.getElementById('tabs-nav').classList.remove('hidden');
            
            const hasPatientName = boxData.admissao.nome && boxData.admissao.nome.trim() !== '';
            const restoreBtn = document.querySelector("button[onclick*='restore']");
            const endBtn = document.querySelector("button[onclick*='end']");
            [restoreBtn, endBtn].forEach(btn => {
                if(btn) {
                    btn.disabled = !hasPatientName;
                    btn.classList.toggle('opacity-50', !hasPatientName);
                    btn.classList.toggle('cursor-not-allowed', !hasPatientName);
                }
            });

            const admissaoContainer = document.getElementById('tab-content-admissao');
            admissaoContainer.innerHTML = '';
            const admissaoTemplate = document.getElementById('admissao-template').content.cloneNode(true);
            admissaoContainer.appendChild(admissaoTemplate);

            Object.keys(boxData.admissao).forEach(field => {
                const input = admissaoContainer.querySelector(`.ad-field[data-field="${field}"]`);
                if (input) input.value = boxData.admissao[field] || '';
            });

            const dailyContainer = document.getElementById('daily-records-container');
            dailyContainer.innerHTML = '';
            boxData.passometros.forEach((record, index) => {
                _addDailyRecord(record, false, index);
            });
            
            updateHeader();
            addEventListeners();
            switchTab(activeTabId);
        }

        // --- MANIPULAÇÃO DE DADOS ---
        function _addDailyRecord(initialData = null, doSaveState = true, index = -1) {
            const boxData = appData[currentBoxId];
            let dataToLoad = {};

            const defaultStructure = 'DIA ANTERIOR: \n12H: \n24H: ';
            const defaultBalanco = 'ACUMULADO: \nDIA ANTERIOR: \n12H: \n24H: ';

            function incrementDayCounters(text) {
                if (!text) return '';
                return text.replace(/\b(D)(\d+)\b/g, (match, p1, p2) => {
                    const dayNumber = parseInt(p2, 10);
                    return p1 + (dayNumber + 1);
                });
            }

            if (initialData) {
                dataToLoad = initialData;
            } else {
                const lastRecord = boxData.passometros.length > 0 ? boxData.passometros[boxData.passometros.length - 1] : null;
                
                if (lastRecord) {
                    const get24hValue = (text) => {
                        if(!text) return 0;
                        const match = text.match(/24(H)?:\s*([+-]?\d*\.?\d+)/i);
                        return match && match[2] ? parseFloat(match[2]) : 0;
                    };
                    const getAcumuladoValue = (text) => {
                        if(!text) return 0;
                        const match = text.match(/ACUMULADO:\s*([+-]?\d*\.?\d+)/i);
                        return match && match[1] ? parseFloat(match[1]) : 0;
                    };
                    
                    const lastDate = new Date(lastRecord.date + 'T00:00:00');
                    lastDate.setDate(lastDate.getDate() + 1);
                    
                    const oldBalancoText = lastRecord.balanco || '';
                    const oldAcumulado = getAcumuladoValue(oldBalancoText);
                    const old24h = get24hValue(oldBalancoText);
                    const newAcumulado = oldAcumulado + old24h;

                    dataToLoad = {
                        date: lastDate.toISOString().split('T')[0],
                        diagPrimario: lastRecord.diagPrimario, diagSecundario: lastRecord.diagSecundario,
                        invasivos: incrementDayCounters(lastRecord.invasivos), 
                        vmO2: lastRecord.vmO2, 
                        atb: incrementDayCounters(lastRecord.atb),
                        especialista: lastRecord.especialista, nutricao: lastRecord.nutricao,
                        culturas: lastRecord.culturas, transfusoes: lastRecord.transfusoes,
                        gasometrias: lastRecord.gasometrias,
                        medicamentos: lastRecord.medicamentos,
                        conduta: lastRecord.conduta, drenos: lastRecord.drenos,
                        glicemias: `DIA ANTERIOR: ${get24hValue(lastRecord.glicemias)}\n12H: \n24H: `,
                        febre: `DIA ANTERIOR: ${get24hValue(lastRecord.febre)}\n12H: \n24H: `,
                        diurese: `DIA ANTERIOR: ${get24hValue(lastRecord.diurese)}\n12H: \n24H: `,
                        balanco: `ACUMULADO: ${newAcumulado.toFixed(0)}\nDIA ANTERIOR: ${old24h.toFixed(0)}\n12H: \n24H: `,
                        evacuacoes: `DIA ANTERIOR: ${get24hValue(lastRecord.evacuacoes)}\n12H: \n24H: `,
                    };
                } else {
                     const today = new Date().toISOString().split('T')[0];
                     dataToLoad = { 
                        date: today,
                        glicemias: defaultStructure,
                        febre: defaultStructure,
                        diurese: defaultStructure,
                        evacuacoes: defaultStructure,
                        balanco: defaultBalanco,
                        drenos: ''
                     };
                }
            }
            
            if (!initialData) {
                 boxData.passometros.push(dataToLoad);
            }

            const template = document.getElementById('daily-record-template');
            const clone = template.content.cloneNode(true);
            const dailyRecordElement = clone.querySelector('.daily-record');
            
            const recordIndex = index !== -1 ? index : boxData.passometros.length - 1;
            dailyRecordElement.dataset.index = recordIndex;

            clone.querySelector('.paciente-nome').value = boxData.admissao.nome;
            clone.querySelector('.comorbidades').value = boxData.admissao.comorbidades;
            
            const recordDateInput = clone.querySelector('.record-date');
            recordDateInput.value = dataToLoad.date || '';
            const recordDateDisplay = clone.querySelector('.record-date-display');
            const updateDateDisplay = () => {
                const dateValue = recordDateInput.value;
                recordDateDisplay.textContent = dateValue ? new Date(dateValue + 'T00:00:00').toLocaleDateString('pt-BR') : 'Nova Data';
            };
            updateDateDisplay();
            
            Object.keys(dataToLoad).forEach(field => {
                const input = clone.querySelector(`.daily-field[data-field="${field}"]`);
                if (input) input.value = dataToLoad[field] || '';
            });

            document.getElementById('daily-records-container').appendChild(clone);
            if (doSaveState) {
                saveState();
                addEventListeners();
            }
        }

        function removeDailyRecord(button) {
            const recordElement = button.closest('.daily-record');
            const indexToRemove = parseInt(recordElement.dataset.index, 10);

            if (!isNaN(indexToRemove) && appData[currentBoxId] && appData[currentBoxId].passometros) {
                appData[currentBoxId].passometros.splice(indexToRemove, 1);
                saveState();
            }
        }

        function addEventListeners() {
            document.querySelectorAll('.ad-field, .daily-field').forEach(input => {
                input.removeEventListener('input', handleFieldInput);
                input.addEventListener('input', handleFieldInput);
            });
        }

        function handleFieldInput(event) {
            const input = event.target;
            const field = input.dataset.field;

            if (input.classList.contains('ad-field')) {
                appData[currentBoxId].admissao[field] = input.value;
                if(field === 'nome' || field === 'comorbidades') {
                    document.querySelectorAll('.paciente-nome').forEach(el => el.value = appData[currentBoxId].admissao.nome);
                    document.querySelectorAll('.comorbidades').forEach(el => el.value = appData[currentBoxId].admissao.comorbidades);
                    updateHeader();
                }
            } else if (input.classList.contains('daily-field')) {
                const recordIndex = input.closest('.daily-record').dataset.index;
                if (recordIndex !== undefined && appData[currentBoxId].passometros[recordIndex]) {
                    appData[currentBoxId].passometros[recordIndex][field] = input.value;
                }
            }
            debounceSaveState();
        }

        // --- AÇÕES DE GERENCIAMENTO ---
        function createNewPassometro() {
            appData[currentBoxId] = getEmptyBoxData();
            saveState();
        }

        async function restoreBackup() {
            alert("Funcionalidade de restauração em desenvolvimento.");
        }

        async function endAndGeneratePdf() {
            if (!appData[currentBoxId] || !appData[currentBoxId].admissao.nome) {
                alert("Não há paciente admitido neste box para gerar o PDF.");
                hideModal();
                return;
            }
            showLoadingModal('Gerando PDF, por favor aguarde...');
            document.body.classList.add('pdf-generating');

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pdfWidth = 210;
            const pdfMargin = 10;
            const contentWidth = pdfWidth - (pdfMargin * 2);

            const admissaoElement = document.querySelector('#tab-content-admissao .form-section');
            const dailyRecords = document.querySelectorAll('#daily-records-container .daily-record');
            
            const allElements = [admissaoElement, ...dailyRecords];

            try {
                for (let i = 0; i < allElements.length; i++) {
                    const element = allElements[i];
                    const canvas = await html2canvas(element, { scale: 3, useCORS: true });
                    const imgData = canvas.toDataURL('image/png');
                    const imgProps = pdf.getImageProperties(imgData);
                    const imgHeight = (imgProps.height * contentWidth) / imgProps.width;

                    if (i > 0) {
                        pdf.addPage();
                    }
                    pdf.addImage(imgData, 'PNG', pdfMargin, pdfMargin, contentWidth, imgHeight);
                }
                
                const pacienteNome = appData[currentBoxId].admissao.nome || 'Paciente';
                pdf.save(`Passometro_BOX_${currentBoxId.replace('box', '0')}_${pacienteNome.replace(/ /g, '_')}.pdf`);
            } catch (error) {
                console.error("Erro ao gerar PDF:", error);
                alert("Ocorreu um erro ao gerar o PDF. Tente novamente.");
            } finally {
                document.body.classList.remove('pdf-generating');
                hideModal();
            }
        }

        // --- MODAL ---
        function showModal(action) {
            modalAction = action;
            const modal = document.getElementById('modal');
            const title = document.getElementById('modal-title');
            const text = document.getElementById('modal-text');
            const confirmBtn = document.getElementById('modal-confirm');
            
            document.getElementById('modal-loading').classList.add('hidden');
            document.getElementById('modal-buttons').classList.remove('hidden');

            const configs = {
                'new': { title: 'Criar Novo Passômetro?', text: 'Esta ação irá apagar TODOS os dados do paciente atual neste box. Deseja continuar?', btnClass: 'bg-green-600' },
                'restore': { title: 'Restaurar Backup?', text: 'Isso reverterá os dados deste box para a última versão salva, descartando alterações não salvas. Confirma?', btnClass: 'bg-yellow-500' },
                'end': { title: 'Encerrar e Gerar PDF?', text: 'Um arquivo PDF com todo o histórico deste paciente será gerado para download. Após isso, você pode limpar os dados do box.', btnClass: 'bg-red-600' }
            };

            title.textContent = configs[action].title;
            text.textContent = configs[action].text;
            confirmBtn.className = `text-white font-bold py-2 px-4 rounded-lg ${configs[action].btnClass}`;
            modal.classList.add('visible');
        }
        
        function showLoadingModal(message) {
            const modal = document.getElementById('modal');
            document.getElementById('modal-buttons').classList.add('hidden');
            document.getElementById('modal-loading').classList.remove('hidden');
            document.getElementById('modal-loading-text').textContent = message;
            modal.classList.add('visible');
        }

        function hideModal() {
            document.getElementById('modal').classList.remove('visible');
            modalAction = null;
        }

        // --- INICIALIZAÇÃO E FUNÇÕES GLOBAIS ---
        window.showModal = showModal;
        window.hideModal = hideModal;
        window.switchTab = switchTab;
        window.addDailyRecord = () => _addDailyRecord(null, true);
        window.removeDailyRecord = removeDailyRecord;

        function initializeAppUI() {
            const boxSelector = document.getElementById('box-selector');
            boxSelector.innerHTML = ''; // Limpa para evitar duplicatas
            for (let i = 1; i <= 9; i++) {
                const boxId = `box${i}`;
                const button = document.createElement('button');
                button.dataset.boxid = boxId;
                button.className = 'w-full text-left px-4 py-2 rounded-lg hover:bg-gray-700 transition duration-200';
                button.textContent = `BOX 0${i}`;
                button.onclick = () => switchBox(boxId);
                boxSelector.appendChild(button);
            }
            
            document.getElementById('modal-confirm').onclick = () => {
                if (modalAction === 'new') createNewPassometro();
                if (modalAction === 'restore') restoreBackup();
                if (modalAction === 'end') endAndGeneratePdf();
                hideModal();
            };
            
            switchBox('box1');
        }

        window.onload = () => {
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
            
            if (firebaseConfig) { // MODO ONLINE
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        if (unsubscribe) unsubscribe();
                        
                        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-passometro-app';
                        const docRef = doc(db, "artifacts", appId, "public", "data", "passometros", "allData");
                        
                        unsubscribe = onSnapshot(docRef, (docSnap) => {
                            document.getElementById('connection-status').textContent = 'Conectado';
                            const onlineData = docSnap.data() || {};
                            
                            const activeElement = document.activeElement;
                            const isInputFocused = activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA');

                            for (let i = 1; i <= 9; i++) {
                                const boxId = `box${i}`;
                                appData[boxId] = onlineData[boxId] ? onlineData[boxId] : null;
                            }
                            
                            if (!currentBoxId) {
                                initializeAppUI();
                            } else if (!isInputFocused) {
                                renderBoxData();
                            }
                        }, (error) => {
                            console.error("Erro no listener do Firestore: ", error);
                            document.getElementById('connection-status').textContent = 'Erro de permissão';
                        });
                    }
                });

                (async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Erro na autenticação: ", error);
                        document.getElementById('connection-status').textContent = 'Falha na autenticação';
                    }
                })();
            } else { // MODO OFFLINE
                document.getElementById('connection-status').textContent = 'Modo Offline';
                loadStateFromLocalStorage();
                initializeAppUI();
            }
        };
    </script>
</body>
</html>
