<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Passômetros - CTI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- SDKs do Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

    <!-- Bibliotecas para Geração de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            --primary-color: #2b6cb0;
            --primary-hover: #2c5282;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .form-section {
            background-color: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 1.5rem;
        }
        .form-field { display: flex; flex-direction: column; }
        .form-field label { font-size: 0.8rem; font-weight: 600; color: #4a5568; margin-bottom: 0.25rem; }
        .form-field input, .form-field textarea, .form-field select {
            border: 1px solid #e2e8f0; border-radius: 0.375rem; padding: 0.5rem 0.75rem;
            font-size: 0.9rem; color: #2d3748; transition: border-color 0.2s;
            line-height: 1.5; 
        }
        .form-field input:focus, .form-field textarea:focus, .form-field select:focus {
            outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 1px var(--primary-color);
        }
        .form-field textarea { 
            resize: none;
            overflow-y: hidden;
        }
        
        .admissao-field {
            display: flex;
            flex-direction: column;
            margin-bottom: 1.5rem;
        }
        .admissao-field label {
            font-size: 0.9rem; font-weight: 700; color: #1a202c; margin-bottom: 0.5rem;
            border-bottom: 2px solid #e2e8f0; padding-bottom: 0.25rem;
        }
        .admissao-field textarea {
            min-height: 220px;
        }

        .checkbox-group label, .radio-group label {
            font-size: 0.9rem;
            font-weight: 500;
            color: #2d3748;
            display: flex;
            align-items: center;
        }
        .checkbox-group input, .radio-group input {
            margin-right: 0.5rem;
            height: 1rem;
            width: 1rem;
        }
        .form-heading {
            grid-column: 1 / -1;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-color);
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 0.5rem;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        .sub-heading {
             font-size: 1rem;
             font-weight: 600;
             color: #1a202c;
             margin-bottom: 0.75rem;
             margin-top: 0.5rem;
             border-bottom: 1px solid #cbd5e0;
             padding-bottom: 0.25rem;
        }
        
        .physio-field {
            border-color: #2d3748;
        }
        
        #consolidado-textarea {
             white-space: pre-wrap;
             word-wrap: break-word;
             font-family: monospace;
             font-size: 0.85rem;
        }

        .col-span-1 { grid-column: span 1 / span 1; }
        .col-span-2 { grid-column: span 2 / span 2; }
        .col-span-3 { grid-column: span 3 / span 3; }
        .col-span-4 { grid-column: span 4 / span 4; }
        .col-span-5 { grid-column: span 5 / span 5; }
        .col-span-6 { grid-column: span 6 / span 6; }
        .col-span-8 { grid-column: span 8 / span 8; }
        .col-span-12 { grid-column: span 12 / span 12; }

        .tab-button {
            padding: 0.75rem 1.5rem; font-weight: 600; cursor: pointer;
            border-bottom: 3px solid transparent; transition: all 0.3s ease;
        }
        .tab-button.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        .tab-button:not(.active):hover { background-color: #edf2f7; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        #loader {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 300px;
        }
        
    </style>
</head>
<body class="bg-gray-100">

    <div class="p-4 sm:p-6 md:p-8 max-w-7xl mx-auto">
        <div id="loader">
            <div class="text-center">
                <svg class="animate-spin h-8 w-8 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                <p class="mt-2 font-semibold text-gray-600">Carregando dados do box...</p>
            </div>
        </div>

        <div id="main-container" class="hidden">
            <header class="mb-6">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                    <div>
                        <p class="text-lg font-semibold text-gray-600">Fundação Hospitalar São Vicente de Paulo - Capelinha/MG</p>
                        <h1 id="header-title" class="text-3xl font-bold text-gray-800">Passômetro CTI</h1>
                        <p id="header-subtitle" class="text-gray-500 mt-1">Nenhum paciente admitido</p>
                    </div>
                </div>
            </header>
            
            <div id="empty-box-message" class="hidden form-section text-center">
                <h3 class="text-xl font-bold text-gray-700">Box Vazio</h3>
                <p class="text-gray-600 my-4">Este box está livre. Para admitir um novo paciente, clique no botão abaixo.</p>
                <button id="btn-new-passometro-empty" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition duration-300 inline-flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    Admitir Novo Paciente
                </button>
            </div>

            <div id="patient-content">
                <div id="management-panel" class="form-section mb-6 no-print">
                    <h3 class="text-lg font-bold text-gray-700 mb-4">Gerenciamento do Passômetro</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <button id="btn-clear-box" class="bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-600 transition duration-300">Limpar Box (Alta)</button>
                        <button id="btn-end-passometro" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition duration-300">Encerrar e Arquivar Online</button>
                    </div>
                </div>

                <div id="tabs-nav" class="border-b border-gray-200 mb-6 no-print">
                    <nav class="flex flex-wrap">
                        <button id="tab-btn-admissao" class="tab-button active">Folha de Admissão</button>
                        <button id="tab-btn-dados-clinicos" class="tab-button">Dados Clínicos</button>
                        <button id="tab-btn-passometro" class="tab-button">Passômetro Diário</button>
                        <button id="tab-btn-arquivo" class="tab-button">Arquivo Online</button>
                    </nav>
                </div>

                <main id="printable-area">
                    <div id="tab-content-admissao" class="tab-content"></div>
                    <div id="tab-content-dados-clinicos" class="tab-content"></div>
                    <div id="tab-content-passometro" class="tab-content">
                        <div class="flex justify-end mb-4 no-print">
                            <button id="btn-add-day" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                                Adicionar Novo Dia
                            </button>
                        </div>
                        <div id="daily-records-container" class="space-y-6"></div>
                    </div>
                     <div id="tab-content-arquivo" class="tab-content"></div>
                </main>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full no-print hidden z-50">
       <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div id="modal-icon" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-gray-100"></div>
                <h3 id="modal-title" class="text-lg leading-6 font-medium text-gray-900 mt-2"></h3>
                <div class="mt-2 px-7 py-3">
                    <p id="modal-text" class="text-sm text-gray-500"></p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="modal-confirm" class="px-4 py-2 text-white text-base font-medium rounded-md w-full shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2">
                        Confirmar
                    </button>
                    <button id="modal-cancel" class="mt-2 px-4 py-2 bg-gray-200 text-gray-900 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="consolidado-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full no-print hidden z-50">
        <div class="relative top-5 mx-auto p-5 border w-full max-w-3xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 class="text-xl leading-6 font-bold text-gray-900">Consolidado para Prontuário (SPDATA)</h3>
                <button id="consolidado-modal-close" class="text-gray-400 hover:text-gray-600">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div class="max-h-[70vh] overflow-y-auto">
                <textarea id="consolidado-textarea" rows="20" class="w-full mt-2 p-2 border border-gray-300 rounded-md bg-gray-50" readonly></textarea>
            </div>
            <div class="items-center px-4 py-3 mt-4 border-t">
                <button id="copy-consolidado-btn" class="mt-2 w-full px-4 py-2 bg-green-600 text-white text-base font-medium rounded-md shadow-sm hover:bg-green-700">
                    Copiar Texto
                </button>
            </div>
        </div>
    </div>

    <!-- Templates -->
    <template id="admissao-template">
       <div class="form-section">
            <header class="text-center mb-8 flex justify-between items-center">
                <div>
                    <p class="text-lg font-semibold text-gray-700">Fundação Hospitalar São Vicente de Paulo - Capelinha/MG</p>
                    <h1 class="text-2xl font-bold text-gray-800">FOLHA DE ADMISSÃO</h1>
                    <p class="text-gray-600">Centro de Terapia Intensiva (CTI)</p>
                </div>
                <div class="flex items-center space-x-2 no-print">
                    <button class="print-pdf-btn text-blue-600 hover:text-blue-800 p-2 rounded-full hover:bg-blue-50" title="Salvar PDF e Imprimir">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                        </svg>
                    </button>
                </div>
            </header>
            <section class="border-t border-b border-gray-200 py-4 mb-8">
                <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
                    <div class="md:col-span-6 form-field !mb-0">
                        <label class="!border-0 !p-0 !m-0 text-sm font-medium text-gray-700">NOME DO PACIENTE</label>
                        <input type="text" data-field="nome" class="ad-field mt-1 block w-full border-gray-300 rounded-md shadow-sm sm:text-sm p-2 leading-normal" placeholder="Nome completo do paciente">
                    </div>
                    <div class="md:col-span-2 form-field !mb-0">
                        <label class="!border-0 !p-0 !m-0 text-sm font-medium text-gray-700">IDADE</label>
                        <input type="text" data-field="idade" class="ad-field mt-1 block w-full border-gray-300 rounded-md shadow-sm sm:text-sm p-2 leading-normal" placeholder="Ex: 53 anos">
                    </div>
                    <div class="md:col-span-2 form-field !mb-0">
                        <label class="!border-0 !p-0 !m-0 text-sm font-medium text-gray-700">DATA ADMISSÃO</label>
                        <input type="date" data-field="dataAdmissao" class="ad-field mt-1 block w-full border-gray-300 rounded-md shadow-sm sm:text-sm p-2 leading-normal">
                    </div>
                     <div class="md:col-span-2 form-field !mb-0">
                        <label class="!border-0 !p-0 !m-0 text-sm font-medium text-gray-700">BOX</label>
                        <input type="text" data-field="box" class="ad-field mt-1 block w-full border-gray-300 rounded-md shadow-sm sm:text-sm p-2 leading-normal" placeholder="Ex: BOX-05" readonly>
                    </div>
                </div>
            </section>
            <main class="grid grid-cols-1 md:grid-cols-2 gap-x-8">
                <div>
                    <div class="admissao-field"><label>HISTÓRIA CLÍNICA ATUAL</label><textarea data-field="historia" class="ad-field"></textarea></div>
                    <div class="admissao-field"><label>TRATAMENTO REALIZADO PREVIAMENTE</label><textarea data-field="tratamentoPrevio" class="ad-field"></textarea></div>
                    <div class="admissao-field"><label>COMORBIDADES (resumo)</label><textarea data-field="comorbidades" class="ad-field"></textarea></div>
                </div>
                <div>
                    <div class="admissao-field"><label>EXAMES RELEVANTES</label><textarea data-field="examesRelevantes" class="ad-field"></textarea></div>
                    <div class="admissao-field"><label>MEDICAMENTOS DE USO CONTÍNUO</label><textarea data-field="medicamentosContinuo" class="ad-field"></textarea></div>
                    <div class="admissao-field"><label>CONDUTA INICIAL</label><textarea data-field="condutaInicial" class="ad-field"></textarea></div>
                </div>
            </main>
        </div>
    </template>
    
    <template id="dados-clinicos-template">
        <div class="form-section">
            <header class="text-center mb-8 flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">DADOS CLÍNICOS E ESCORES</h1>
                    <p class="text-gray-600">Informações complementares da admissão</p>
                </div>
                 <div class="flex items-center space-x-2 no-print">
                    <button class="print-pdf-btn text-blue-600 hover:text-blue-800 p-2 rounded-full hover:bg-blue-50" title="Salvar PDF e Imprimir">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" /></svg>
                    </button>
                </div>
            </header>
            <p id="dados-clinicos-patient-name" class="text-lg font-semibold text-gray-700 mb-6 border-b pb-2"></p>
            <div class="form-grid">
                
                <h3 class="form-heading col-span-12">Comorbidades Detalhadas</h3>
                <div class="col-span-12 grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="space-y-4 radio-group">
                        <div class="sub-heading">Insuficiência Cardíaca</div>
                        <label><input type="radio" name="comorb_icc_nyha" value="2-3" class="dc-field">NYHA Classes II-III</label>
                        <label><input type="radio" name="comorb_icc_nyha" value="4" class="dc-field">NYHA Classe IV</label>
                    </div>
                    <div class="space-y-4 radio-group">
                        <div class="sub-heading">Insuficiência Renal Crônica</div>
                        <label><input type="radio" name="comorb_irc_dialise" value="sem" class="dc-field">Sem diálise</label>
                        <label><input type="radio" name="comorb_irc_dialise" value="com" class="dc-field">Em diálise</label>
                    </div>
                     <div class="space-y-4 radio-group">
                        <div class="sub-heading">Cirrose (Child-Pugh)</div>
                        <label><input type="radio" name="comorb_cirrose_child" value="a-b" class="dc-field">Child A-B</label>
                        <label><input type="radio" name="comorb_cirrose_child" value="c" class="dc-field">Child C</label>
                    </div>
                </div>
                
                 <div class="col-span-12 grid grid-cols-1 md:grid-cols-3 gap-8 mt-4 checkbox-group">
                    <div>
                        <div class="sub-heading">Cardiovascular</div>
                        <div class="space-y-2">
                             <div><label><input type="checkbox" data-field="comorb_angina" class="dc-field"> Angina</label></div>
                             <div><label><input type="checkbox" data-field="comorb_has" class="dc-field"> Hipertensão Arterial</label></div>
                             <div><label><input type="checkbox" data-field="comorb_tvp" class="dc-field"> Trombose venosa profunda</label></div>
                             <div><label><input type="checkbox" data-field="comorb_dap" class="dc-field"> Doença arterial periférica</label></div>
                             <div><label><input type="checkbox" data-field="comorb_iam" class="dc-field"> IAM prévio</label></div>
                             <div><label><input type="checkbox" data-field="comorb_fa" class="dc-field"> Fibrilação atrial crônica</label></div>
                             <div><label><input type="checkbox" data-field="comorb_arritmias" class="dc-field"> Outras arritmias cardíacas</label></div>
                        </div>
                    </div>
                    <div>
                        <div class="sub-heading">Neurológicas e Psiquiátricas</div>
                        <div class="space-y-2">
                            <div><label><input type="checkbox" data-field="comorb_alcoolismo" class="dc-field"> Alcoolismo</label></div>
                            <div><label><input type="checkbox" data-field="comorb_demencia" class="dc-field"> Demência</label></div>
                            <div><label><input type="checkbox" data-field="comorb_drogas" class="dc-field"> Dependência de subst. psicoativas</label></div>
                            <div><label><input type="checkbox" data-field="comorb_avc_sequela" class="dc-field"> AVC com sequela</label></div>
                            <div><label><input type="checkbox" data-field="comorb_avc_sem_sequela" class="dc-field"> AVC sem sequela</label></div>
                            <div><label><input type="checkbox" data-field="comorb_psiquiatrica" class="dc-field"> Doença psiquiátrica</label></div>
                            <div><label><input type="checkbox" data-field="comorb_tabagismo" class="dc-field"> Tabagismo (nos últimos 12m)</label></div>
                        </div>
                    </div>
                    <div>
                        <div class="sub-heading">Endócrinas, Metabólicas e Outras</div>
                        <div class="space-y-2">
                            <div><label><input type="checkbox" data-field="comorb_desnutricao" class="dc-field"> Desnutrição</label></div>
                            <div><label><input type="checkbox" data-field="comorb_reumatica" class="dc-field"> Doenças reumáticas</label></div>
                            <div><label><input type="checkbox" data-field="comorb_hipertireoidismo" class="dc-field"> Hipertireoidismo</label></div>
                            <div><label><input type="checkbox" data-field="comorb_dm_complic" class="dc-field"> Diabetes c/ complicações</label></div>
                            <div><label><input type="checkbox" data-field="comorb_dm_sem_complic" class="dc-field"> Diabetes s/ complicações</label></div>
                            <div><label><input type="checkbox" data-field="comorb_obesidade" class="dc-field"> Obesidade mórbida</label></div>
                            <div><label><input type="checkbox" data-field="comorb_dislipidemia" class="dc-field"> Dislipidemias</label></div>
                            <div><label><input type="checkbox" data-field="comorb_hipotireoidismo" class="dc-field"> Hipotireoidismo</label></div>
                        </div>
                    </div>
                </div>

                <h3 class="form-heading col-span-12">Eventos Agudos na Internação</h3>
                <div class="col-span-12 md:col-span-6 border-r pr-4 checkbox-group">
                    <strong class="text-gray-700 mb-2 block">À internação na unidade (+/- 1h)</strong>
                    <div class="grid grid-cols-2 gap-2">
                        <div><label><input type="checkbox" data-field="evento_1h_aminas" class="dc-field"> Aminas vasoativas > 1h</label></div>
                        <div><label><input type="checkbox" data-field="evento_1h_vm" class="dc-field"> Ventilação Mecânica</label></div>
                        <div><label><input type="checkbox" data-field="evento_1h_vni" class="dc-field"> Ventilação não-invasiva</label></div>
                        <div><label><input type="checkbox" data-field="evento_1h_suporte_renal" class="dc-field"> Suporte renal</label></div>
                        <div><label><input type="checkbox" data-field="evento_1h_ira" class="dc-field"> Insuficiência respiratória aguda</label></div>
                        <div><label><input type="checkbox" data-field="evento_1h_arritmia" class="dc-field"> Arritmia cardíaca</label></div>
                        <div><label><input type="checkbox" data-field="evento_1h_insuf_renal" class="dc-field"> Insuficiência renal aguda</label></div>
                        <div><label><input type="checkbox" data-field="evento_1h_massa_ic" class="dc-field"> Efeito massa intracraniano</label></div>
                        <div><label><input type="checkbox" data-field="evento_1h_neutropenia" class="dc-field"> Neutropenia</label></div>
                        <div><label><input type="checkbox" data-field="evento_1h_pcr" class="dc-field"> Parada cardiorrespiratória</label></div>
                        <div><label><input type="checkbox" data-field="evento_1h_hemorragia" class="dc-field"> Hemorragia digestiva</label></div>
                    </div>
                </div>
                <div class="col-span-12 md:col-span-6 checkbox-group">
                    <strong class="text-gray-700 mb-2 block">Durante as primeiras 24h de internação</strong>
                     <div class="grid grid-cols-2 gap-2">
                        <div><label><input type="checkbox" data-field="evento_24h_aminas" class="dc-field"> Aminas vasoativas > 1h</label></div>
                        <div><label><input type="checkbox" data-field="evento_24h_vm" class="dc-field"> Ventilação Mecânica</label></div>
                        <div><label><input type="checkbox" data-field="evento_24h_vni" class="dc-field"> Ventilação não-invasiva</label></div>
                        <div><label><input type="checkbox" data-field="evento_24h_suporte_renal" class="dc-field"> Suporte renal</label></div>
                        <div><label><input type="checkbox" data-field="evento_24h_ira" class="dc-field"> Insuficiência respiratória aguda</label></div>
                        <div><label><input type="checkbox" data-field="evento_24h_arritmia" class="dc-field"> Arritmia cardíaca</label></div>
                        <div><label><input type="checkbox" data-field="evento_24h_insuf_renal" class="dc-field"> Insuficiência renal aguda</label></div>
                        <div><label><input type="checkbox" data-field="evento_24h_massa_ic" class="dc-field"> Efeito massa intracraniano</label></div>
                        <div><label><input type="checkbox" data-field="evento_24h_neutropenia" class="dc-field"> Neutropenia</label></div>
                        <div><label><input type="checkbox" data-field="evento_24h_pcr" class="dc-field"> Parada cardiorrespiratória</label></div>
                        <div><label><input type="checkbox" data-field="evento_24h_hemorragia" class="dc-field"> Hemorragia digestiva</label></div>
                    </div>
                </div>

                <h3 class="form-heading col-span-12">Dados Fisiológicos e Laboratoriais (Pior resultado à admissão +/- 1h)</h3>
                <div class="col-span-12 md:col-span-6 border-r pr-4">
                     <strong class="text-gray-700 mb-2 block">Dados Fisiológicos</strong>
                     <div class="grid grid-cols-2 gap-x-4 gap-y-2">
                        <label>Pressão arterial (mmHg)</label><input type="text" data-field="fisio_pa" class="dc-field physio-field">
                        <label>Pressão arterial média (mmHg)</label><input type="number" data-field="fisio_pam" class="dc-field physio-field">
                        <label>Frequência cardíaca (bpm)</label><input type="number" data-field="fisio_fc" class="dc-field physio-field">
                        <label>Frequência respiratória (irpm)</label><input type="number" data-field="fisio_fr" class="dc-field physio-field">
                        <label>Temperatura (°C)</label><input type="number" step="0.1" data-field="fisio_temp" class="dc-field physio-field">
                        <label>Escala de Coma (Glasgow)</label><input type="number" data-field="fisio_glasgow" class="dc-field physio-field">
                     </div>
                </div>
                <div class="col-span-12 md:col-span-6">
                    <strong class="text-gray-700 mb-2 block">Dados Laboratoriais</strong>
                     <div class="grid grid-cols-2 gap-x-4 gap-y-2">
                        <label>Leucócitos (x10³/mm³)</label><input type="number" step="0.1" data-field="lab_leuco" class="dc-field">
                        <label>Plaquetas (x10³/mm³)</label><input type="number" data-field="lab_plaquetas" class="dc-field">
                        <label>Creatinina (mg/dL)</label><input type="number" step="0.1" data-field="lab_creatinina" class="dc-field">
                        <label>Ureia (mg/dL)</label><input type="number" data-field="lab_ureia" class="dc-field">
                        <label>Bilirrubinas totais (mg/dL)</label><input type="number" step="0.1" data-field="lab_bilirrubina" class="dc-field">
                        <label>pH</label><input type="number" step="0.01" data-field="lab_ph" class="dc-field">
                        <label>PaO₂ (mmHg)</label><input type="number" data-field="lab_pao2" class="dc-field">
                        <label>PaCO₂ (mmHg)</label><input type="number" data-field="lab_paco2" class="dc-field">
                        <label>Lactato arterial (mmol/L)</label><input type="number" step="0.1" data-field="lab_lactato" class="dc-field">
                     </div>
                </div>

                 <h3 class="form-heading col-span-12">Priorização e Cuidados Paliativos</h3>
                 <div class="form-field col-span-12 md:col-span-6">
                    <label>Prioridade de internação (Resolução CFM 2.156/2016)</label>
                    <select class="dc-field" data-field="prioridade_cfm">
                        <option value="">Não avaliado</option>
                        <option value="p1">Prioridade 1: Paciente crítico com alta probabilidade de recuperação</option>
                        <option value="p2">Prioridade 2: Paciente com alto risco, necessita de monitoramento intensivo</option>
                        <option value="p3">Prioridade 3: Paciente crítico com baixa probabilidade de recuperação</option>
                        <option value="p4">Prioridade 4: Paciente com doença crônica agudizada, benefício da UTI é baixo</option>
                        <option value="p5">Prioridade 5: Paciente em fase terminal, sem possibilidade de recuperação</option>
                    </select>
                 </div>
                 <div class="form-field col-span-12 md:col-span-6 radio-group">
                    <label>Decisão para limitar/retirar terapias?</label>
                    <div class="mt-2 space-y-2">
                        <label><input type="radio" name="cuidadosPaliativos" value="nao" class="dc-field">Não</label>
                        <label><input type="radio" name="cuidadosPaliativos" value="onr" class="dc-field">Sim, ordem de não ressuscitação (ONR)</label>
                        <label><input type="radio" name="cuidadosPaliativos" value="ni" class="dc-field">Sim, não intensificar</label>
                        <label><input type="radio" name="cuidadosPaliativos" value="limitar" class="dc-field">Sim, limitar</label>
                        <label><input type="radio" name="cuidadosPaliativos" value="retirar" class="dc-field">Sim, retirar</label>
                    </div>
                 </div>

            </div>
        </div>
    </template>

    <template id="daily-record-template">
       <div class="form-section daily-record">
            <div class="flex justify-between items-center border-b pb-2 mb-6">
                 <h2 class="text-xl font-bold text-gray-700">Passômetro - Dia <span class="record-date-display"></span></h2>
                 <div class="flex items-center space-x-2 no-print">
                     <button class="generate-consolidado-btn text-green-600 hover:text-green-800 p-1.5 rounded-full hover:bg-green-50" title="Gerar Consolidado para SPDATA">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                    </button>
                    <button class="print-pdf-btn text-blue-600 hover:text-blue-800 p-1.5 rounded-full hover:bg-blue-50" title="Salvar PDF e Imprimir">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                        </svg>
                    </button>
                    <button class="remove-btn text-red-500 hover:text-red-700 p-1.5 rounded-full hover:bg-red-50" title="Remover este dia">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    </button>
                 </div>
            </div>
            <div class="form-grid">
                <div class="form-field col-span-12 sm:col-span-5"><label>PACIENTE</label><input type="text" class="paciente-nome" readonly></div>
                <div class="form-field col-span-4 sm:col-span-2"><label>DATA</label><input type="date" class="record-date daily-field" data-field="date"></div>
                <div class="form-field col-span-8 sm:col-span-5"><label>COMORBIDADES</label><input type="text" class="comorbidades" readonly></div>
                
                <!-- Linha Diagnósticos -->
                <div class="form-field col-span-12 sm:col-span-4"><label>DIAGNÓSTICO PRIMÁRIO</label><textarea class="daily-field" data-field="diagPrimario" style="min-height: 150px;"></textarea></div>
                <div class="form-field col-span-12 sm:col-span-8"><label>DIAGNÓSTICO SECUNDÁRIO</label><textarea class="daily-field" data-field="diagSecundario" style="min-height: 150px;"></textarea></div>

                <!-- Linha Invasivos, ATB, Culturas -->
                <div class="form-field col-span-12 sm:col-span-4"><label>INVASIVOS</label><textarea class="daily-field" data-field="invasivos" style="min-height: 100px;"></textarea></div>
                <div class="form-field col-span-12 sm:col-span-4"><label>ATB</label><textarea class="daily-field" data-field="atb" style="min-height: 100px;"></textarea></div>
                <div class="form-field col-span-12 sm:col-span-4"><label>CULTURAS</label><textarea class="daily-field" data-field="culturas" style="min-height: 100px;"></textarea></div>

                <!-- Linha Gasometria, VM, Especialista -->
                <div class="form-field col-span-12 sm:col-span-6"><label>GASOMETRIAS</label><textarea class="daily-field" data-field="gasometrias" style="min-height: 100px;"></textarea></div>
                <div class="form-field col-span-12 sm:col-span-3"><label>VM/O2 SUPLEMENTAR</label><textarea class="daily-field" data-field="vmO2" style="min-height: 100px;"></textarea></div>
                <div class="form-field col-span-12 sm:col-span-3"><label>ESPECIALISTA</label><textarea class="daily-field" data-field="especialista" style="min-height: 100px;"></textarea></div>
                
                <!-- Linha Evoluções -->
                <div class="form-field col-span-12 sm:col-span-6">
                    <div class="flex justify-between items-center mb-1">
                        <label>DIURNO - EVOLUÇÃO</label>
                    </div>
                    <textarea class="daily-field" data-field="evoDiurno" style="min-height: 150px;"></textarea>
                </div>
                <div class="form-field col-span-12 sm:col-span-6">
                     <div class="flex justify-between items-center mb-1">
                        <label>NOTURNO - EVOLUÇÃO</label>
                    </div>
                    <textarea class="daily-field" data-field="evoNoturno" style="min-height: 150px;"></textarea>
                </div>

                <!-- Linha Nutrição, Glicemias, Febre, Transfusões -->
                <div class="form-field col-span-12 sm:col-span-3"><label>NUTRIÇÃO</label><textarea class="daily-field" data-field="nutricao" style="min-height: 100px;"></textarea></div>
                <div class="form-field col-span-12 sm:col-span-3"><label>GLICEMIAS</label><textarea class="daily-field" data-field="glicemias" style="min-height: 100px;"></textarea></div>
                <div class="form-field col-span-12 sm:col-span-3"><label>FEBRE</label><textarea class="daily-field" data-field="febre" style="min-height: 100px;"></textarea></div>
                <div class="form-field col-span-12 sm:col-span-3"><label>TRANSFUSÕES</label><textarea class="daily-field" data-field="transfusoes" style="min-height: 100px;"></textarea></div>

                <!-- Linha Diurese, Balanço, Evacuações, Drenos -->
                <div class="form-field col-span-12 sm:col-span-3"><label>DIURESE</label><textarea class="daily-field" data-field="diurese" style="min-height: 100px;"></textarea></div>
                <div class="form-field col-span-12 sm:col-span-3"><label>BALANÇO HÍDRICO</label><textarea class="daily-field" data-field="balanco" style="min-height: 100px;"></textarea></div>
                <div class="form-field col-span-12 sm:col-span-3"><label>EVACUAÇÕES</label><textarea class="daily-field" data-field="evacuacoes" style="min-height: 100px;"></textarea></div>
                <div class="form-field col-span-12 sm:col-span-3"><label>DRENOS</label><textarea class="daily-field" data-field="drenos" style="min-height: 100px;"></textarea></div>

                <!-- Linha Final -->
                <div class="form-field col-span-12 sm:col-span-4"><label>MEDICAMENTOS</label><textarea class="daily-field" data-field="medicamentos" style="min-height: 200px;"></textarea></div>
                <div class="form-field col-span-12 sm:col-span-4"><label>EXAMES DO DIA / RELEVANTES</label><textarea class="daily-field" data-field="exames" style="min-height: 200px;"></textarea></div>
                <div class="form-field col-span-12 sm:col-span-4"><label>CONDUTA</label><textarea class="daily-field" data-field="conduta" style="min-height: 200px;"></textarea></div>
            </div>
        </div>
    </template>

    <template id="arquivo-template">
        <div class="form-section">
            <header class="text-center mb-8">
                <h1 class="text-2xl font-bold text-gray-800">ARQUIVO DE PACIENTES</h1>
                <p class="text-gray-600">PDFs de altas anteriores para este BOX</p>
            </header>
            <div id="archive-list" class="space-y-3">
                <!-- A lista de arquivos será inserida aqui -->
            </div>
        </div>
    </template>
    
    <!-- Script Principal -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- VARIÁVEIS GLOBAIS ---
            let appData = null;
            let currentBoxId = null;
            let db = null;
            let storage = null; 
            let firestoreUnsubscribe = null;
            let modalAction = null;
            let debounceTimer;

            // --- CONFIGURAÇÃO DO FIREBASE ---
            const firebaseConfig = {
                apiKey: "AIzaSyBgYHmtifm1odYFQAxrMCTL4AxIm8Bsc54",
                authDomain: "passometro-cti-hospital.firebaseapp.com",
                projectId: "passometro-cti-hospital",
                storageBucket: "passometro-cti-hospital.appspot.com",
                messagingSenderId: "385304756594",
                appId: "1:385304756594:web:c64297893b836397c8ddeb"
            };

            // --- FUNÇÕES DE ESTRUTURA E ESTADO ---
            function getEmptyData() {
                const today = new Date().toISOString().split('T')[0];
                return {
                    admissao: {
                        nome: '', idade: '', dataAdmissao: today, box: currentBoxId,
                        historia: '', tratamentoPrevio: '', comorbidades: '',
                        examesRelevantes: '', medicamentosContinuo: '', condutaInicial: ''
                    },
                    dadosClinicos: {},
                    passometros: []
                };
            }
            function updateFirestoreData() {
                if (db && currentBoxId && appData) {
                    const cleanData = JSON.parse(JSON.stringify(appData));
                    db.collection('passometros').doc(currentBoxId).set(cleanData)
                        .catch(error => console.error("Erro ao salvar dados: ", error));
                }
            }
            function debounceUpdateFirestore() {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(updateFirestoreData, 800);
            }
            function listenToBoxData(boxId) {
                 if (firestoreUnsubscribe) firestoreUnsubscribe();

                const activeElement = document.activeElement;
                const activeElementIdentifier = {
                    field: activeElement ? activeElement.dataset.field : null,
                    name: activeElement ? activeElement.name : null,
                    index: activeElement && activeElement.closest('.daily-record') ? activeElement.closest('.daily-record').dataset.index : null,
                    selectionStart: activeElement ? activeElement.selectionStart : null,
                    selectionEnd: activeElement ? activeElement.selectionEnd : null,
                };
                
                const docRef = db.collection('passometros').doc(boxId);
                firestoreUnsubscribe = docRef.onSnapshot(doc => {
                    if (doc.exists) {
                        appData = doc.data();
                        if (!appData.passometros) appData.passometros = [];
                        if (!appData.dadosClinicos) appData.dadosClinicos = {};
                    } else {
                        appData = null; 
                    }
                    render();

                    if (activeElementIdentifier.field || activeElementIdentifier.name) {
                        let elementToFocus;
                        if (activeElementIdentifier.index) {
                            const recordElement = document.querySelector(`.daily-record[data-index="${activeElementIdentifier.index}"]`);
                            if (recordElement) {
                                elementToFocus = recordElement.querySelector(`[data-field="${activeElementIdentifier.field}"]`);
                            }
                        } else {
                            elementToFocus = document.querySelector(`[data-field="${activeElementIdentifier.field}"], [name="${activeElementIdentifier.name}"]`);
                        }

                        if (elementToFocus) {
                            elementToFocus.focus();
                            if (typeof elementToFocus.setSelectionRange === 'function') {
                                elementToFocus.setSelectionRange(activeElementIdentifier.selectionStart, activeElementIdentifier.selectionEnd);
                            }
                        }
                    }

                    hideLoader();
                }, error => {
                    console.error("Erro ao escutar dados: ", error);
                    alert("Não foi possível conectar ao banco de dados.");
                    hideLoader();
                });
            }
            
            // --- FUNÇÕES DE UI ---
            function showLoader() { document.getElementById('loader').style.display = 'flex'; document.getElementById('main-container').classList.add('hidden'); }
            function hideLoader() { document.getElementById('loader').style.display = 'none'; document.getElementById('main-container').classList.remove('hidden'); }

            function switchTab(tabName) {
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                const button = document.getElementById(`tab-btn-${tabName}`);
                const content = document.getElementById(`tab-content-${tabName}`);
                if(button) button.classList.add('active');
                if(content) content.classList.add('active');
            }
            
            function updateHeader() {
                const boxTitle = currentBoxId ? ` - ${currentBoxId.replace('-', ' ')}` : '';
                document.getElementById('header-title').textContent = `Passômetro CTI${boxTitle}`;
                const nome = appData && appData.admissao ? appData.admissao.nome : '';
                document.getElementById('header-subtitle').textContent = nome ? `Paciente: ${nome}` : 'Nenhum paciente admitido';
                const dcPatientName = document.getElementById('dados-clinicos-patient-name');
                if(dcPatientName) dcPatientName.textContent = 'Paciente: ' + (nome || 'Não informado');
            }

            function render() {
                if (appData === null) {
                    document.getElementById('empty-box-message').classList.remove('hidden');
                    document.getElementById('patient-content').classList.add('hidden');
                } else {
                    document.getElementById('empty-box-message').classList.add('hidden');
                    document.getElementById('patient-content').classList.remove('hidden');

                    const activeTabButton = document.querySelector('#tabs-nav .tab-button.active');
                    const activeTabId = activeTabButton ? activeTabButton.id.replace('tab-btn-', '') : 'admissao';

                    const admissaoContainer = document.getElementById('tab-content-admissao');
                    admissaoContainer.innerHTML = '';
                    const admissaoTemplate = document.getElementById('admissao-template').content.cloneNode(true);
                    admissaoContainer.appendChild(admissaoTemplate);
                    Object.keys(appData.admissao).forEach(field => {
                        const input = admissaoContainer.querySelector(`.ad-field[data-field="${field}"]`);
                        if (input) input.value = appData.admissao[field] || '';
                    });
                    admissaoContainer.querySelector('.ad-field[data-field="box"]').value = currentBoxId;

                    const dadosClinicosContainer = document.getElementById('tab-content-dados-clinicos');
                    dadosClinicosContainer.innerHTML = '';
                    const dadosClinicosTemplate = document.getElementById('dados-clinicos-template').content.cloneNode(true);
                    dadosClinicosContainer.appendChild(dadosClinicosTemplate);
                    if(appData.dadosClinicos) {
                        dadosClinicosContainer.querySelectorAll('.dc-field').forEach(input => {
                            const field = input.dataset.field || input.name;
                            const value = appData.dadosClinicos[field];
                            if (input.type === 'radio') {
                                if (input.value === value) input.checked = true;
                            } else if (input.type === 'checkbox') {
                                input.checked = !!value;
                            } else {
                                input.value = value || '';
                            }
                        });
                    }

                    const dailyContainer = document.getElementById('daily-records-container');
                    dailyContainer.innerHTML = '';
                    if (appData.passometros) {
                        appData.passometros.forEach((record, index) => _addDailyRecordUI(record, index));
                    }
                    
                    switchTab(activeTabId);
                }
                updateHeader();
                addEventListeners();
            }

            // --- FUNÇÕES DE DADOS ---
            function admitNewPatient() {
                appData = getEmptyData();
                updateFirestoreData();
            }
            
            function addDailyRecord() {
                if (!appData.passometros) appData.passometros = [];

                const get24hLineValue = (text) => {
                    if (!text) return '';
                    const match = text.match(/24\s*H(?:ORAS)?:\s*([^\n]*)/i);
                    return match && match[1] ? match[1].trim() : '';
                };

                const getNumeric24hValue = (text) => {
                    if (!text) return 0;
                    const match = text.match(/24\s*H(?:ORAS)?:\s*([+-]?\d*\.?\d+)/i);
                    return match && match[1] ? parseFloat(match[1]) : 0;
                };
                
                const incrementDayCounters = (text) => {
                    if (!text) return '';
                    return text.replace(/\b(D)(\d+)\b/gi, (match, p1, p2) => {
                        const dayNumber = parseInt(p2, 10);
                        return p1 + (dayNumber + 1);
                    });
                };

                let newRecord = {};
                const lastRecord = appData.passometros.length > 0 ? appData.passometros[appData.passometros.length - 1] : null;

                if (lastRecord) {
                    const lastDate = new Date(lastRecord.date + 'T12:00:00Z');
                    lastDate.setDate(lastDate.getDate() + 1);
                    
                    const totalAcumulado = appData.passometros.reduce((acc, record) => {
                        return acc + getNumeric24hValue(record.balanco);
                    }, 0);

                    newRecord = {
                        date: lastDate.toISOString().split('T')[0],
                        diagPrimario: lastRecord.diagPrimario,
                        diagSecundario: lastRecord.diagSecundario,
                        invasivos: incrementDayCounters(lastRecord.invasivos),
                        atb: incrementDayCounters(lastRecord.atb),
                        culturas: lastRecord.culturas,
                        gasometrias: lastRecord.gasometrias,
                        vmO2: lastRecord.vmO2,
                        especialista: lastRecord.especialista,
                        evoDiurno: '',
                        evoNoturno: '',
                        nutricao: lastRecord.nutricao,
                        transfusoes: lastRecord.transfusoes,
                        medicamentos: lastRecord.medicamentos,
                        exames: lastRecord.exames,
                        conduta: lastRecord.conduta,
                        glicemias: `DIA ANTERIOR: ${get24hLineValue(lastRecord.glicemias)}\n12 HORAS:\n24 HORAS:`,
                        febre: `DIA ANTERIOR: ${get24hLineValue(lastRecord.febre)}\n12 HORAS:\n24 HORAS:`,
                        diurese: `DIA ANTERIOR: ${get24hLineValue(lastRecord.diurese)}\n12 HORAS:\n24 HORAS:`,
                        evacuacoes: `DIA ANTERIOR: ${get24hLineValue(lastRecord.evacuacoes)}\n12 HORAS:\n24 HORAS:`,
                        drenos: `DIA ANTERIOR: ${get24hLineValue(lastRecord.drenos)}\n12 HORAS:\n24 HORAS:`,
                        balanco: `ACUMULADO: ${totalAcumulado.toFixed(0)}\nDIA ANTERIOR: ${getNumeric24hValue(lastRecord.balanco).toFixed(0)}\n12 HORAS:\n24 HORAS:`,
                    };
                } else {
                    newRecord = {
                        date: appData.admissao.dataAdmissao || new Date().toISOString().split('T')[0],
                        glicemias: `DIA ANTERIOR:\n12 HORAS:\n24 HORAS:`,
                        febre: `DIA ANTERIOR:\n12 HORAS:\n24 HORAS:`,
                        diurese: `DIA ANTERIOR:\n12 HORAS:\n24 HORAS:`,
                        evacuacoes: `DIA ANTERIOR:\n12 HORAS:\n24 HORAS:`,
                        drenos: `DIA ANTERIOR:\n12 HORAS:\n24 HORAS:`,
                        balanco: `ACUMULADO: 0\nDIA ANTERIOR:\n12 HORAS:\n24 HORAS:`,
                    };
                }
                
                appData.passometros.push(newRecord);
                updateFirestoreData();
            }
            
            function _addDailyRecordUI(recordData, index) {
                const template = document.getElementById('daily-record-template').content.cloneNode(true);
                const dailyRecordElement = template.querySelector('.daily-record');
                dailyRecordElement.dataset.index = index;
                template.querySelector('.paciente-nome').value = appData.admissao.nome || '';
                template.querySelector('.comorbidades').value = appData.admissao.comorbidades || '';
                const recordDateInput = template.querySelector('.record-date');
                const recordDateDisplay = template.querySelector('.record-date-display');
                if(recordData.date) {
                    recordDateInput.value = recordData.date;
                    recordDateDisplay.textContent = new Date(recordData.date + 'T12:00:00Z').toLocaleDateString('pt-BR');
                }
                Object.keys(recordData).forEach(field => {
                    const input = template.querySelector(`.daily-field[data-field="${field}"]`);
                    if(input) input.value = recordData[field] || '';
                });
                document.getElementById('daily-records-container').appendChild(template);
            }

            function removeDailyRecord(button) {
                const recordElement = button.closest('.daily-record');
                const indexToRemove = parseInt(recordElement.dataset.index, 10);
                if (!isNaN(indexToRemove)) {
                    appData.passometros.splice(indexToRemove, 1);
                    updateFirestoreData();
                }
            }
            function autoResizeTextarea(textarea) {
                if(textarea) {
                    textarea.style.height = 'auto';
                    textarea.style.height = (textarea.scrollHeight) + 'px';
                }
            }

            function addEventListeners() {
                document.querySelectorAll('textarea').forEach(textarea => { 
                    textarea.addEventListener('input', () => autoResizeTextarea(textarea));
                    setTimeout(() => autoResizeTextarea(textarea), 0);
                });
                document.querySelectorAll('.ad-field, .daily-field, .dc-field').forEach(input => {
                    input.addEventListener('input', handleFieldInput);
                    input.addEventListener('change', handleFieldInput);
                });
                document.querySelectorAll('.print-pdf-btn').forEach(btn => { 
                    btn.addEventListener('click', () => downloadAndPrintSection(btn));
                });
                document.querySelectorAll('.remove-btn').forEach(btn => {
                    btn.addEventListener('click', () => removeDailyRecord(btn));
                 });
                document.querySelectorAll('.generate-consolidado-btn').forEach(btn => {
                    btn.addEventListener('click', () => showConsolidadoModal(btn));
                });
            }

            function handleFieldInput(event) {
                const input = event.target;
                const field = input.dataset.field || input.name;
                
                if (input.classList.contains('ad-field')) {
                    appData.admissao[field] = input.value;
                    if(field === 'nome') updateHeader();
                } else if (input.classList.contains('dc-field')) {
                    if(!appData.dadosClinicos) appData.dadosClinicos = {};
                     if (input.type === 'radio') {
                        if(input.checked) appData.dadosClinicos[field] = input.value;
                    } else if (input.type === 'checkbox') {
                        appData.dadosClinicos[field] = input.checked;
                    } else {
                        appData.dadosClinicos[field] = input.value;
                    }
                } else if (input.closest('.daily-record')) {
                    const recordIndex = input.closest('.daily-record').dataset.index;
                    if (recordIndex !== undefined && appData.passometros[recordIndex]) {
                        appData.passometros[recordIndex][input.dataset.field] = input.value;
                    }
                }
                debounceUpdateFirestore();
            }

            // --- AÇÕES DE GERENCIAMENTO E PDF ---
            function clearBox() { 
                if (db && currentBoxId) {
                    db.collection('passometros').doc(currentBoxId).delete();
                }
            }

            function prepareElementForCanvas(element) {
                const textareas = element.querySelectorAll('textarea');
                textareas.forEach(textarea => {
                    const pre = document.createElement('pre');
                    pre.textContent = textarea.value;
                    const style = window.getComputedStyle(textarea);
                    pre.style.cssText = `font-family:${style.fontFamily};font-size:${style.fontSize};white-space:pre-wrap;word-wrap:break-word;border:${style.border};border-radius:${style.borderRadius};padding:${style.padding};min-height:${textarea.style.height};display:block;color:${style.color};background-color:${style.backgroundColor};line-height:${style.lineHeight};`;
                    pre.dataset.isClone = 'true';
                    textarea.style.display = 'none';
                    textarea.parentNode.insertBefore(pre, textarea);
                });
            }

            function cleanupElementAfterCanvas(element) {
                element.querySelectorAll('pre[data-is-clone="true"]').forEach(clone => clone.remove());
                element.querySelectorAll('textarea').forEach(textarea => textarea.style.display = '');
            }

            async function endPassometro() {
                if (!appData || !appData.admissao.nome) { hideModal(); return; }
                showModal('generatingPDF');
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const allElements = [
                    document.querySelector('#tab-content-admissao .form-section'),
                    document.querySelector('#tab-content-dados-clinicos .form-section'),
                    ...document.querySelectorAll('#daily-records-container .daily-record')
                ].filter(Boolean);

                try {
                    for (let i = 0; i < allElements.length; i++) {
                        const element = allElements[i];
                        prepareElementForCanvas(element);
                        const canvas = await html2canvas(element, { scale: 2.5, useCORS: true, windowHeight: element.scrollHeight, scrollY: -window.scrollY });
                        cleanupElementAfterCanvas(element);
                        const imgData = canvas.toDataURL('image/png');
                        const imgProps = pdf.getImageProperties(imgData);
                        const imgHeight = (imgProps.height * (210 - 20)) / imgProps.width;
                        if (i > 0) pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 10, 10, 210 - 20, imgHeight, undefined, 'FAST');
                    }
                    const pacienteNome = appData.admissao.nome.replace(/[^a-zA-Z0-9]/g, '_') || 'Paciente';
                    const dataAdmissao = appData.admissao.dataAdmissao || 'sem_data';
                    const dataAlta = new Date().toISOString().split('T')[0];
                    const fileName = `${pacienteNome}_Admissao-${dataAdmissao}_Alta-${dataAlta}.pdf`;
                    
                    const pdfBlob = pdf.output('blob');

                    const storageRef = storage.ref(`arquivos_passometro/${currentBoxId}/${fileName}`);
                    await storageRef.put(pdfBlob);
                    
                    pdf.save(fileName);
                    clearBox();
                } catch (error) {
                    console.error("Erro ao gerar ou arquivar PDF:", error);
                    alert("Ocorreu um erro ao arquivar o PDF. Verifique o console para mais detalhes.")
                    allElements.forEach(el => cleanupElementAfterCanvas(el));
                } finally {
                    hideModal();
                }
            }

            async function downloadAndPrintSection(button) { /* ... */ }

            // --- CONSOLIDADO SPDATA ---
            function showConsolidadoModal(button) {
                const recordElement = button.closest('.daily-record');
                const index = parseInt(recordElement.dataset.index, 10);
                if (isNaN(index)) return;

                const dailyData = appData.passometros[index];
                const fieldsInOrder = [
                    { title: 'DIAGNÓSTICO PRIMÁRIO', value: dailyData.diagPrimario },
                    { title: 'DIAGNÓSTICO SECUNDÁRIO', value: dailyData.diagSecundario },
                    { title: 'INVASIVOS', value: dailyData.invasivos },
                    { title: 'ATB', value: dailyData.atb },
                    { title: 'CULTURAS', value: dailyData.culturas },
                    { title: 'GASOMETRIAS', value: dailyData.gasometrias },
                    { title: 'VM/O2 SUPLEMENTAR', value: dailyData.vmO2 },
                    { title: 'ESPECIALISTA', value: dailyData.especialista },
                    { title: 'DIURNO - EVOLUÇÃO', value: dailyData.evoDiurno },
                    { title: 'NOTURNO - EVOLUÇÃO', value: dailyData.evoNoturno },
                    { title: 'NUTRIÇÃO', value: dailyData.nutricao },
                    { title: 'GLICEMIAS', value: dailyData.glicemias },
                    { title: 'FEBRE', value: dailyData.febre },
                    { title: 'TRANSFUSÕES', value: dailyData.transfusoes },
                    { title: 'DIURESE', value: dailyData.diurese },
                    { title: 'BALANÇO HÍDRICO', value: dailyData.balanco },
                    { title: 'EVACUAÇÕES', value: dailyData.evacuacoes },
                    { title: 'DRENOS', value: dailyData.drenos },
                    { title: 'MEDICAMENTOS', value: dailyData.medicamentos },
                    { title: 'EXAMES DO DIA / RELEVANTES', value: dailyData.exames },
                    { title: 'CONDUTA', value: dailyData.conduta },
                ];
                
                let consolidadoText = '';
                fieldsInOrder.forEach(field => {
                    if (field.value && field.value.trim() !== '') {
                        consolidadoText += `#${field.title}\n${field.value.trim()}\n\n`;
                    }
                });

                const modal = document.getElementById('consolidado-modal');
                const textarea = document.getElementById('consolidado-textarea');
                textarea.value = consolidadoText;
                autoResizeTextarea(textarea);
                modal.classList.remove('hidden');
            }

            function copyConsolidadoText() {
                const textarea = document.getElementById('consolidado-textarea');
                textarea.select();
                document.execCommand('copy');
                const copyBtn = document.getElementById('copy-consolidado-btn');
                copyBtn.textContent = 'Copiado!';
                setTimeout(() => { copyBtn.textContent = 'Copiar Texto'; }, 2000);
            }

            // --- ARQUIVO ONLINE ---
            async function renderArchive() {
                const container = document.getElementById('tab-content-arquivo');
                container.innerHTML = document.getElementById('arquivo-template').content.cloneNode(true).firstElementChild.outerHTML;
                const listContainer = container.querySelector('#archive-list');
                listContainer.innerHTML = '<p class="text-center text-gray-500">Buscando arquivos...</p>';

                if (!storage || !currentBoxId) {
                    listContainer.innerHTML = '<p class="text-center text-red-500">Serviço de armazenamento não está disponível.</p>';
                    return;
                }

                const listRef = storage.ref(`arquivos_passometro/${currentBoxId}`);
                try {
                    const res = await listRef.listAll();
                    if (res.items.length === 0) {
                        listContainer.innerHTML = '<p class="text-center text-gray-500">Nenhum arquivo encontrado para este box.</p>';
                        return;
                    }

                    listContainer.innerHTML = '';
                    const filePromises = res.items.map(async itemRef => {
                        const url = await itemRef.getDownloadURL();
                        const parts = itemRef.name.replace('.pdf', '').split('_');
                        const nome = parts[0] || "Nome não encontrado";
                        const admissao = parts[1] || "Admissão: N/A";
                        const alta = parts[2] || "Alta: N/A";
                        return { url, nome, admissao, alta, name: itemRef.name };
                    });

                    const files = await Promise.all(filePromises);
                    
                    files.sort((a, b) => b.name.localeCompare(a.name)); 

                    files.forEach(file => {
                        const listItem = document.createElement('a');
                        listItem.href = file.url;
                        listItem.target = '_blank';
                        listItem.className = 'block bg-gray-50 p-3 rounded-md hover:bg-blue-100 transition duration-300 border';
                        listItem.innerHTML = `
                            <div class="flex items-center space-x-4">
                               <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0011.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>
                               <div>
                                 <p class="font-bold text-blue-800">${file.nome.replace(/-/g, ' ')}</p>
                                 <p class="text-sm text-gray-600">${file.admissao.replace(/-/g, '/')} | ${file.alta.replace(/-/g, '/')}</p>
                               </div>
                            </div>
                        `;
                        listContainer.appendChild(listItem);
                    });
                } catch (error) {
                    console.error("Erro ao listar arquivos:", error);
                    listContainer.innerHTML = '<p class="text-center text-red-500">Ocorreu um erro ao buscar os arquivos. Verifique as regras de segurança do Storage.</p>';
                }
            }

            // --- MODAIS ---
            function showModal(action) { /* ... (mesma lógica anterior) ... */ }
            function hideModal() { /* ... */ }
            
            // --- INICIALIZAÇÃO ---
            function getBoxIdFromUrl() {
                const params = new URLSearchParams(window.location.search);
                const box = params.get('box');
                return box ? box.toUpperCase().replace(' ', '-') : 'BOX-01';
            }

            function initializeApp() {
                try {
                    if (!firebase.apps.length) {
                         firebase.initializeApp(firebaseConfig);
                    }
                    db = firebase.firestore();
                    storage = firebase.storage();
                } catch (e) {
                    console.error("Erro ao inicializar o Firebase.", e);
                    alert("ERRO DE CONFIGURAÇÃO: Verifique as credenciais do Firebase no código.");
                    return;
                }

                currentBoxId = getBoxIdFromUrl();
                showLoader();
                listenToBoxData(currentBoxId);

                document.getElementById('modal-confirm').onclick = () => {
                    if (modalAction === 'clear') clearBox();
                    if (modalAction === 'end') endPassometro();
                    hideModal();
                };
                document.getElementById('modal-cancel').onclick = hideModal;
                document.getElementById('btn-clear-box').addEventListener('click', () => showModal('clear'));
                document.getElementById('btn-end-passometro').addEventListener('click', () => showModal('end'));
                document.getElementById('btn-new-passometro-empty').addEventListener('click', admitNewPatient);
                document.getElementById('btn-add-day').addEventListener('click', addDailyRecord);
                document.getElementById('tab-btn-admissao').addEventListener('click', () => switchTab('admissao'));
                document.getElementById('tab-btn-dados-clinicos').addEventListener('click', () => switchTab('dados-clinicos'));
                document.getElementById('tab-btn-passometro').addEventListener('click', () => switchTab('passometro'));
                document.getElementById('tab-btn-arquivo').addEventListener('click', () => {
                    switchTab('arquivo');
                    renderArchive();
                });

                document.getElementById('consolidado-modal-close').addEventListener('click', () => document.getElementById('consolidado-modal').classList.add('hidden'));
                document.getElementById('copy-consolidado-btn').addEventListener('click', copyConsolidadoText);
            }
            
            initializeApp();
        });
    </script>
</body>
</html>

